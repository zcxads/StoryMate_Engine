version: '3.8'

services:
  storymate-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: storymate-engine
    ports:
      - "8001:8000"
    environment:
      - APP_NAME=StoryMate Engine
      - APP_VERSION=1.0.0
      - DEBUG=True
      - OUTPUT_DIR=tts_output
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL}
      # ğŸš€ íƒ€ì„ì•„ì›ƒ ì„¤ì • ëŒ€í­ ì¦ê°€ (ë¬´ì œí•œì— ê°€ê¹ê²Œ)
      - UVICORN_TIMEOUT_KEEP_ALIVE=0
      - UVICORN_GRACEFUL_TIMEOUT=0
      - LLM_REQUEST_TIMEOUT=0  # 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë¬´ì œí•œ ëŒ€ê¸°
      # ğŸ“Š LangSmith ì„¤ì •
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-true}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT:-https://api.smith.langchain.com}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
    volumes:
      # TTS ì¶œë ¥ íŒŒì¼ì„ í˜¸ìŠ¤íŠ¸ì— ì €ì¥ (ê¶Œí•œ ìˆ˜ì •)
      - ./tts_output:/app/tts_output:rw
      # ë¡œê·¸ ë””ë ‰í† ë¦¬ (ì„ íƒì‚¬í•­)
      - ./logs:/app/logs:rw
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - storymate-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 120s  # 2ë¶„ë§ˆë‹¤ ì²´í¬
      timeout: 600s  # 10ë¶„ íƒ€ì„ì•„ì›ƒ
      retries: 3
      start_period: 120s  # ì‹œì‘ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
    # ê¶Œí•œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì¶”ê°€ ì„¤ì •
    user: "0:0"  # root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰

networks:
  storymate-network:
    driver: bridge

volumes:
  tts_output:
    driver: local
